# GFlowNet Peptide - Session TODO

**Created**: 2025-12-24 23:33 JST
**Last Updated**: 2025-12-25 01:30 JST
**Previous TODO**: [TODO-2025-12-24-0934.md](./TODO-2025-12-24-0934.md)

---

## Current Phase: Phase 0b - Improved Reward Validation (COMPLETED)

**Objective**: Fix ESM-2 pseudo-likelihood reward hacking by implementing an entropy-gated reward function, then re-train GRPO-D to determine if the diversity problem persists.

**Status**: Phase 0b training completed successfully. GO/NO-GO decision made.

---

## In Progress

No training jobs currently running.

---

## Completed This Session

### Training

- [x] **Phase 0b GRPO-D Training** (10h 6m)
  - W&B Run: https://wandb.ai/ewijaya/gflownet-peptide/runs/udhmfpso
  - Final metrics: Loss=0.0793, Mean R=0.9617, Diversity=0.5447
  - Checkpoint: `checkpoints/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_final.pt`

### Evaluation & Analysis

- [x] Computed sequence entropy distribution (mean=0.83, target >0.6)
- [x] Quantified repeat patterns:
  - Homopolymer rate: 10.9% (was 97% in Phase 0a)
  - Dipeptide repeats: 45.3%
  - Tripeptide repeats: 22.7%
- [x] Analyzed amino acid composition (W, M, H, Y over-represented)
- [x] HDBSCAN clustering: 2 clusters + 74% noise (spread distribution)
- [x] K-means clustering: 15 balanced clusters
- [x] Sequence diversity: 0.945 (all 128 sequences unique)
- [x] Identified over-represented motifs: QRP (143x), TLG, PYP, ICI

### Documentation

- [x] Updated `docs/TODO-2025-12-24-0934.md` with training results
- [x] Updated `docs/prd-phase-0b-improved-reward.md` with final metrics
- [x] Rewrote `docs/phase0_decision.md` with comprehensive Phase 0a vs 0b comparison

### Maintenance

- [x] Cleaned intermediate checkpoints (freed ~7.6GB)
  - Removed: `_iter200.pt`, `_iter400.pt`, `_iter600.pt`, `_iter800.pt`
  - Kept: `_final.pt` files only

---

## Decision: GO for GFlowNet (Three-Way Comparison)

### Rationale

Both GRPO-D versions establish baselines for GFlowNet comparison:

| Metric | GRPO-D Vanilla (0a) | GRPO-D Improved (0b) | GFlowNet Target |
|--------|---------------------|----------------------|-----------------|
| Homopolymer rate | 97% | 10.9% | ≤ Improved |
| Mean entropy | ~0.30 | 0.83 | ≥ Improved |
| Sequence diversity | 0.895 | 0.945 | ≥ Improved |
| Cluster count | 3 | 15 | ≥3× Improved |
| Unique sequences | No | Yes | Yes |

### Three-Way Comparison Strategy

| Comparison | What It Demonstrates |
|------------|---------------------|
| **GFlowNet vs GRPO-D Vanilla** | GFlowNet robustness to reward hacking |
| **GFlowNet vs GRPO-D Improved** | GFlowNet diversity advantage with fixed reward |
| **GRPO-D Improved vs Vanilla** | Importance of reward design |

### Remaining Characteristics to Quantify (Phase 1)

1. **Motif over-representation**: QRP, TLG appear 100x+ more than expected
2. **AA bias**: W (3.9x), M (2.7x), H (2.2x), Y (2.1x) vs natural
3. **Dipeptide repeats**: 45% have patterns like ICIC, FYFY

---

## Next Steps

### Phase 1: Reward Model + Baseline Characterization

- [ ] Download and preprocess FLIP stability dataset
- [ ] Download and preprocess Propedia binding dataset
- [ ] Train ESM-2 → Stability predictor (target R² ≥ 0.6)
- [ ] Train ESM-2 → Binding predictor (target R² ≥ 0.5)
- [ ] Implement composite reward function

### Phase 1: GRPO-D Baseline Characterization (Both Versions)

- [ ] Document Phase 0a (Vanilla) metrics from `outputs/grpo_metrics.json`
- [ ] Run ESMFold on Phase 0b peptides for pLDDT scores
- [ ] Compare AA composition to APD3/UniProt
- [ ] Analyze motif frequency vs natural databases
- [ ] Generate `outputs/grpod_baseline_metrics.json`

### Phase 2: GFlowNet Implementation (GO)

- [ ] Implement forward policy (causal Transformer)
- [ ] Implement trajectory balance loss
- [ ] Use same reward model as GRPO-D (fair comparison)

---

## Observations

### What Worked

- **Entropy gate eliminated homopolymers**: 97% → 10.9%
- **Embedding naturalness** as reward signal works better than pseudo-likelihood
- **Multiplicative reward combination** ensures all components must be good
- **GRPO-D with proper reward** achieves high diversity (0.945)

### What to Monitor

- **Dipeptide repeats (45%)**: Not as severe as homopolymers, but may indicate partial reward hacking
- **AA composition bias**: Over-representation of W, M, H, Y needs biological validation
- **Motif frequency**: QRP, TLG, PYP appearing 100x+ expected - may be exploiting ESM-2 biases

### Key Insight

> The Phase 0a "diversity problem" was actually a **reward function problem**, not an optimization method problem. Fixing the reward (entropy gate + embedding naturalness) fixed the diversity.

### Project Direction Update

> Adopted **Perspective B**: GFlowNet proceeds regardless of GRPO-D quality. Both GRPO-D versions (Vanilla and Improved) serve as baselines for three-way comparison in Phase 4.

---

## Files Modified

| File | Action |
|------|--------|
| `docs/TODO-2025-12-24-0934.md` | Modified (training completion) |
| `docs/prd-phase-0b-improved-reward.md` | Modified (final metrics) |
| `docs/phase0_decision.md` | Rewritten (GO for GFlowNet, three-way comparison) |
| `docs/prd-phase-1-reward-model.md` | Created (Phase 1 PRD with baseline characterization) |
| `outputs/phase0b_embeddings.npy` | Created |
| `outputs/phase0b_umap.npy` | Created |
| `outputs/phase0b_clusters.npy` | Created |
| `results/grpo/*_peptides.csv` | Committed (Phase 0b peptides) |
| `results/grpo/*_stats.csv` | Committed (Phase 0b statistics) |

---

## Artifacts

### Phase 0b Output Files

- **Peptides**: `results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_peptides.csv`
- **Statistics**: `results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_stats.csv`
- **Checkpoint**: `checkpoints/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_final.pt`
- **W&B**: https://wandb.ai/ewijaya/gflownet-peptide/runs/udhmfpso

### Analysis Outputs

- `outputs/phase0b_embeddings.npy` - ESM-2 embeddings (128, 320)
- `outputs/phase0b_umap.npy` - 2D UMAP projection
- `outputs/phase0b_clusters.npy` - HDBSCAN cluster labels

---

## Commands Reference

```bash
# Check training status
/wandb-status

# Clean checkpoints after training
/clean-checkpoints

# View generated peptides
head -20 results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_peptides.csv

# Analyze peptide diversity
python scripts/evaluate.py --gflownet_samples results/grpo/*_peptides.csv
```

---

*End of TODO*
