# GFlowNet Peptide - Session TODO

**Created**: 2025-12-24 23:33 JST
**Last Updated**: 2025-12-24 23:33 JST
**Previous TODO**: [TODO-2025-12-24-0934.md](./TODO-2025-12-24-0934.md)

---

## Current Phase: Phase 0b - Improved Reward Validation (COMPLETED)

**Objective**: Fix ESM-2 pseudo-likelihood reward hacking by implementing an entropy-gated reward function, then re-train GRPO-D to determine if the diversity problem persists.

**Status**: Phase 0b training completed successfully. GO/NO-GO decision made.

---

## In Progress

No training jobs currently running.

---

## Completed This Session

### Training

- [x] **Phase 0b GRPO-D Training** (10h 6m)
  - W&B Run: https://wandb.ai/ewijaya/gflownet-peptide/runs/udhmfpso
  - Final metrics: Loss=0.0793, Mean R=0.9617, Diversity=0.5447
  - Checkpoint: `checkpoints/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_final.pt`

### Evaluation & Analysis

- [x] Computed sequence entropy distribution (mean=0.83, target >0.6)
- [x] Quantified repeat patterns:
  - Homopolymer rate: 10.9% (was 97% in Phase 0a)
  - Dipeptide repeats: 45.3%
  - Tripeptide repeats: 22.7%
- [x] Analyzed amino acid composition (W, M, H, Y over-represented)
- [x] HDBSCAN clustering: 2 clusters + 74% noise (spread distribution)
- [x] K-means clustering: 15 balanced clusters
- [x] Sequence diversity: 0.945 (all 128 sequences unique)
- [x] Identified over-represented motifs: QRP (143x), TLG, PYP, ICI

### Documentation

- [x] Updated `docs/TODO-2025-12-24-0934.md` with training results
- [x] Updated `docs/prd-phase-0b-improved-reward.md` with final metrics
- [x] Rewrote `docs/phase0_decision.md` with comprehensive Phase 0a vs 0b comparison

### Maintenance

- [x] Cleaned intermediate checkpoints (freed ~7.6GB)
  - Removed: `_iter200.pt`, `_iter400.pt`, `_iter600.pt`, `_iter800.pt`
  - Kept: `_final.pt` files only

---

## Decision: CONDITIONAL NO-GO for GFlowNet

### Rationale

| Metric | Phase 0a | Phase 0b | Improvement |
|--------|----------|----------|-------------|
| Homopolymer rate | 97% | **10.9%** | -86% |
| Mean entropy | 0.30 | **0.83** | +177% |
| Sequence diversity | 0.895 | **0.945** | +6% |
| Unique sequences | No | **100%** | Fixed |

The improved reward function solved the primary diversity problem. GFlowNet can be **deferred** unless biological validation reveals quality issues.

### Remaining Concerns

1. **Motif over-representation**: QRP, TLG appear 100x+ more than expected
2. **AA bias**: W (3.9x), M (2.7x), H (2.2x), Y (2.1x) vs natural
3. **Dipeptide repeats**: 45% have patterns like ICIC, FYFY

---

## Next Steps

### Immediate

- [ ] Validate peptide quality via structure prediction (ESMFold)
- [ ] Compare generated peptides to known therapeutic peptides
- [ ] Create Phase 0b UMAP visualization for comparison

### Phase 1 Planning

- [ ] Review Phase 1 PRD (reward model training on FLIP/Propedia)
- [ ] Prepare FLIP stability dataset
- [ ] Design reward model architecture (ESM-2 backbone + MLP heads)

### Conditional

- [ ] IF biological validation fails → Implement GFlowNet (Phase 2)
- [ ] IF biological validation passes → Continue with GRPO-D

---

## Observations

### What Worked

- **Entropy gate eliminated homopolymers**: 97% → 10.9%
- **Embedding naturalness** as reward signal works better than pseudo-likelihood
- **Multiplicative reward combination** ensures all components must be good
- **GRPO-D with proper reward** achieves high diversity (0.945)

### What to Monitor

- **Dipeptide repeats (45%)**: Not as severe as homopolymers, but may indicate partial reward hacking
- **AA composition bias**: Over-representation of W, M, H, Y needs biological validation
- **Motif frequency**: QRP, TLG, PYP appearing 100x+ expected - may be exploiting ESM-2 biases

### Key Insight

> The Phase 0a "diversity problem" was actually a **reward function problem**, not an optimization method problem. Fixing the reward (entropy gate + embedding naturalness) fixed the diversity.

---

## Files Modified

| File | Action |
|------|--------|
| `docs/TODO-2025-12-24-0934.md` | Modified (training completion) |
| `docs/prd-phase-0b-improved-reward.md` | Modified (final metrics) |
| `docs/phase0_decision.md` | Rewritten (comprehensive analysis) |
| `outputs/phase0b_embeddings.npy` | Created |
| `outputs/phase0b_umap.npy` | Created |
| `outputs/phase0b_clusters.npy` | Created |

---

## Artifacts

### Phase 0b Output Files

- **Peptides**: `results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_peptides.csv`
- **Statistics**: `results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_stats.csv`
- **Checkpoint**: `checkpoints/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_final.pt`
- **W&B**: https://wandb.ai/ewijaya/gflownet-peptide/runs/udhmfpso

### Analysis Outputs

- `outputs/phase0b_embeddings.npy` - ESM-2 embeddings (128, 320)
- `outputs/phase0b_umap.npy` - 2D UMAP projection
- `outputs/phase0b_clusters.npy` - HDBSCAN cluster labels

---

## Commands Reference

```bash
# Check training status
/wandb-status

# Clean checkpoints after training
/clean-checkpoints

# View generated peptides
head -20 results/grpo/20251224_093311_grpod_it1000_dw0.15_beta0.04_peptides.csv

# Analyze peptide diversity
python scripts/evaluate.py --gflownet_samples results/grpo/*_peptides.csv
```

---

*End of TODO*
